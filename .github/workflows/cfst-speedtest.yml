name: Cloudflare Speed Test

on:
  schedule:
    # æ¯å¤© UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  speedtest:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ============================================================
      # æ­¥éª¤ 1: è·å– Cloudflare å…¨éƒ¨ IPv4 æ®µ
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Cloudflare IPv4 ranges
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä» Cloudflare API è·å– IPv4 åœ°å€æ®µ..."
          response=$(curl -s https://api.cloudflare.com/client/v4/ips)

          success=$(echo "$response" | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "âŒ Cloudflare API è¯·æ±‚å¤±è´¥"
            echo "$response" | jq .
            exit 1
          fi

          echo "$response" | jq -r '.result.ipv4_cidrs[]' > ip_all.txt
          echo "âœ… å·²è·å– Cloudflare IPv4 æ®µï¼š"
          cat ip_all.txt
          echo "ğŸ“Š å…± $(wc -l < ip_all.txt) ä¸ª CIDR æ®µ"

      # ============================================================
      # æ­¥éª¤ 2: åœ¨ GitHub Actions å†…ç­›é€‰é¦™æ¸¯(HKG)æ•°æ®ä¸­å¿ƒ IP
      # ============================================================
      - name: Filter HKG datacenter IPs
        run: |
          echo "ğŸ” æ­£åœ¨ä½¿ç”¨ bin/cfst ç­›é€‰ç»è¿‡é¦™æ¸¯(HKG)æ•°æ®ä¸­å¿ƒçš„ IP..."
          chmod +x bin/cfst
          # ä½¿ç”¨ HTTPing æ¨¡å¼ + cfcolo HKG ç­›é€‰ + ç¦ç”¨ä¸‹è½½æµ‹è¯•
          bin/cfst -f ip_all.txt -httping -cfcolo HKG -dd -o hkg_result.csv

          echo "ğŸ“‹ HKG ç­›é€‰ç»“æœï¼š"
          cat hkg_result.csv

          # æå–é€šè¿‡ HKG ç­›é€‰çš„ IP åˆ—è¡¨ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼Œå–ç¬¬ä¸€åˆ— IPï¼‰
          if [ -f hkg_result.csv ] && [ $(wc -l < hkg_result.csv) -gt 1 ]; then
            tail -n +2 hkg_result.csv | cut -d',' -f1 > ip_hk.txt
            echo "âœ… ç­›é€‰å‡º $(wc -l < ip_hk.txt) ä¸ªé¦™æ¸¯æ•°æ®ä¸­å¿ƒ IP"
            cat ip_hk.txt
          else
            echo "âŒ æœªæ‰¾åˆ°ç»è¿‡ HKG æ•°æ®ä¸­å¿ƒçš„ IP"
            exit 1
          fi

      # ============================================================
      # æ­¥éª¤ 3: é€šè¿‡ cloudflared å»ºç«‹ SSH éš§é“
      # ============================================================
      - name: Setup cloudflared
        run: |
          echo "ğŸ“¦ æ­£åœ¨è®¾ç½® cloudflared..."
          chmod +x bin/cloudflared

      - name: Start cloudflared SSH tunnel
        run: |
          echo "ğŸ” æ­£åœ¨å»ºç«‹ Cloudflare Tunnel SSH è¿æ¥..."
          nohup bin/cloudflared access ssh \
            --hostname ${{ secrets.SSH_HOST }} \
            --url ssh://127.0.0.1:2202 \
            > /tmp/cloudflared.log 2>&1 &

          echo "â³ ç­‰å¾…éš§é“å»ºç«‹..."
          for i in $(seq 1 30); do
            if nc -z 127.0.0.1 2202 2>/dev/null; then
              echo "âœ… SSH éš§é“å·²åœ¨ 127.0.0.1:2202 å»ºç«‹"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "âŒ SSH éš§é“å»ºç«‹è¶…æ—¶"
              cat /tmp/cloudflared.log
              exit 1
            fi
            sleep 2
          done

      # ============================================================
      # æ­¥éª¤ 4: ä¸Šä¼ ç­›é€‰åçš„ ip_hk.txt åˆ°è¿œç¨‹ä¸»æœº
      # ============================================================
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Upload ip_hk.txt to remote server
        run: |
          echo "ğŸ“¤ æ­£åœ¨ä¸Šä¼ ç­›é€‰åçš„ ip_hk.txt åˆ°è¿œç¨‹ä¸»æœº..."
          sshpass -p '${{ secrets.SSH_PASSWORD }}' \
            scp -P 2202 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ip_hk.txt \
            ${{ secrets.SSH_USERNAME }}@127.0.0.1:/root/cfst/ip_hk.txt
          echo "âœ… ip_hk.txt (ä»…å« HKG IP) å·²ä¸Šä¼ åˆ° /root/cfst/ip_hk.txt"

      # ============================================================
      # æ­¥éª¤ 5: å®¶åº­ä¸»æœºä»…æ‰§è¡Œä¸‹è½½æµ‹é€Ÿï¼ˆIP å·²ç»è¿‡ HKG ç­›é€‰ï¼‰
      # ============================================================
      - name: Run speed test on remote server
        id: speedtest
        run: |
          echo "ğŸš€ æ­£åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œä¸‹è½½æµ‹é€Ÿï¼ˆä»…å·²ç­›é€‰çš„ HKG IPï¼‰..."
          sshpass -p '${{ secrets.SSH_PASSWORD }}' \
            ssh -p 2202 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SSH_USERNAME }}@127.0.0.1 \
            "cd /root/cfst && ./cfst -f ip_hk.txt -url ${{ secrets.SPEEDTEST_URL }}" \
            | tee /tmp/cfst_output.txt

          echo "âœ… æµ‹é€Ÿå®Œæˆ"

      # ============================================================
      # æ­¥éª¤ 6: æå–æœ€å¿« IP ä¿å­˜åˆ° cf-host-ip.txt
      # ============================================================
      - name: Extract fastest IP
        run: |
          echo "ğŸ“Š æ­£åœ¨æå–ä¸‹è½½é€Ÿåº¦æœ€å¿«çš„ IP..."

          sshpass -p '${{ secrets.SSH_PASSWORD }}' \
            scp -P 2202 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            ${{ secrets.SSH_USERNAME }}@127.0.0.1:/root/cfst/result.csv \
            /tmp/result.csv

          echo "ğŸ“‹ æµ‹é€Ÿç»“æœï¼š"
          cat /tmp/result.csv

          # è§£æ CSV: è·³è¿‡æ ‡é¢˜è¡Œï¼ŒæŒ‰ä¸‹è½½é€Ÿåº¦ï¼ˆæœ€åä¸€åˆ—ï¼‰æ’åºå–æœ€å¿«
          fastest_ip=$(tail -n +2 /tmp/result.csv | sort -t',' -k6 -rn | head -1 | cut -d',' -f1)

          if [ -z "$fastest_ip" ]; then
            echo "âŒ æœªèƒ½æå–åˆ°æœ‰æ•ˆ IP"
            exit 1
          fi

          echo "$fastest_ip" > cf-host-ip.txt
          echo "âœ… æœ€å¿« IP: $fastest_ip"
          echo "FASTEST_IP=$fastest_ip" >> $GITHUB_ENV

      # ============================================================
      # æ­¥éª¤ 7: æ¨é€ cf-host-ip.txt åˆ° suwei8/blog
      # ============================================================
      - name: Push cf-host-ip.txt to blog repo
        run: |
          echo "ğŸš€ æ­£åœ¨æ¨é€ cf-host-ip.txt åˆ° suwei8/blog..."

          git clone https://x-access-token:${{ secrets.BLOG_DEPLOY_TOKEN }}@github.com/suwei8/blog.git /tmp/blog

          cp cf-host-ip.txt /tmp/blog/cf-host-ip.txt

          cd /tmp/blog
          git config user.name "CFST-Bot"
          git config user.email "cfst-bot@github.com"
          git add cf-host-ip.txt
          git diff --cached --quiet && echo "â„¹ï¸ IP æœªå˜åŒ–ï¼Œæ— éœ€æ¨é€" || {
            git commit -m "ğŸ”„ æ›´æ–°æœ€å¿« Cloudflare IP: ${{ env.FASTEST_IP }} ($(date -u +%Y-%m-%d))"
            git push
            echo "âœ… å·²æ¨é€åˆ° suwei8/blog"
          }

      # ============================================================
      # æ¸…ç†
      # ============================================================
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸­..."
          pkill cloudflared || true
          echo "âœ… æ¸…ç†å®Œæˆ"
